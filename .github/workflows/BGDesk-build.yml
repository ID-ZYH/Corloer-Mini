name: Build BGDesk Windows EXE (Fast)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  push:
    branches: [ "master", "main" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/android*'
      - '.github/workflows/ios*'

env:
  # æ ¸å¿ƒç¯å¢ƒå˜é‡ (ä¿ç•™è‡ªå®˜æ–¹é…ç½®)
  SCITER_RUST_VERSION: "1.75"
  RUST_VERSION: "1.75"
  LLVM_VERSION: "15.0.6"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  VERSION: "1.4.5"
  TAG_NAME: "nightly"
  # ç­¾åç›¸å…³ (å¦‚æœ‰é…ç½®)
  SIGN_BASE_URL: "${{ secrets.SIGN_BASE_URL }}-2"
  UPLOAD_ARTIFACT: "true"

jobs:
  # 1. ç”Ÿæˆæ¡¥æ¥ä»£ç  (å¿…é¡»ä¿ç•™)
  generate-bridge:
    uses: ./.github/workflows/bridge.yml

  # 2. ç¼–è¯‘ç½®é¡¶çª—å£ç»„ä»¶ (Windowsç‰ˆå¿…é¡»ä¿ç•™)
  build-RustDeskTempTopMostWindow:
    uses: ./.github/workflows/third-party-RustDeskTempTopMostWindow.yml
    with:
      upload-artifact: true
      target: windows-2022
      configuration: Release
      platform: x64
      target_version: Windows10
    strategy:
      fail-fast: false

  # 3. ä¸»æ„å»ºä»»åŠ¡ (ç²¾ç®€ç‰ˆ - ä»… Windows)
  build-for-windows-flutter:
    name: Build BGDesk (Windows x64)
    needs: [build-RustDeskTempTopMostWindow, generate-bridge]
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        job:
          - {
              target: x86_64-pc-windows-msvc,
              os: windows-2022,
              arch: x86_64,
              vcpkg-triplet: x64-windows-static,
            }
    steps:
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v6
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: ${{ env.LLVM_VERSION }}

      - name: Install flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # æ›¿æ¢ Flutter å¼•æ“ (å®˜æ–¹ä¼˜åŒ–)
      - name: Replace engine with rustdesk custom flutter engine
        run: |
          flutter doctor -v
          flutter precache --windows
          Invoke-WebRequest -Uri https://github.com/rustdesk/engine/releases/download/main/windows-x64-release.zip -OutFile windows-x64-release.zip
          Expand-Archive -Path windows-x64-release.zip -DestinationPath windows-x64-release
          mv -Force windows-x64-release/* C:/hostedtoolcache/windows/flutter/stable-${{ env.FLUTTER_VERSION }}-x64/bin/cache/artifacts/engine/windows-x64-release/

      - name: Patch flutter
        shell: bash
        run: |
          cp .github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "3.24.5" == ${{env.FLUTTER_VERSION}} ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.SCITER_RUST_VERSION }}
          targets: ${{ matrix.job.target }}
          components: "rustfmt"

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ matrix.job.os }}

      - name: Setup vcpkg with Github Actions binary cache
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: C:\vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false

      - name: Install vcpkg dependencies
        env:
          VCPKG_DEFAULT_HOST_TRIPLET: ${{ matrix.job.vcpkg-triplet }}
        run: |
          if ! $VCPKG_ROOT/vcpkg \
            install \
            --triplet ${{ matrix.job.vcpkg-triplet }} \
            --x-install-root="$VCPKG_ROOT/installed"; then
            echo "VCPKG install failed"
            exit 1
          fi
        shell: bash

      # ğŸ”¥ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šç¼–è¯‘å¹¶å¤„ç†æ–‡ä»¶å
      - name: Build BGDesk
        run: |
          # 1. ç¼–è¯‘
          python3 .\build.py --portable --hwcodec --flutter --vram --skip-portable-pack
          
          # 2. ç§»åŠ¨äº§ç‰©ç›®å½•
          mv ./flutter/build/windows/x64/runner/Release ./rustdesk
          
          # 3. ã€å…³é”®ã€‘å¤åˆ¶ä¸€ä»½ BGDesk.exe ä¾›ç»¿è‰²ç‰ˆä½¿ç”¨ï¼Œä¿ç•™ rustdesk.exe ä¾› MSI (å¦‚æœå¼€å¯) ä½¿ç”¨
          cp ./rustdesk/rustdesk.exe ./rustdesk/BGDesk.exe

          # 4. ä¸‹è½½å¹¶é…ç½®è™šæ‹Ÿæ˜¾ç¤ºå™¨é©±åŠ¨ (ä¿æŒåŸé€»è¾‘)
          Invoke-WebRequest -Uri https://github.com/rustdesk-org/rdev/releases/download/usbmmidd_v2/usbmmidd_v2.zip -OutFile usbmmidd_v2.zip
          Expand-Archive usbmmidd_v2.zip -DestinationPath .
          Remove-Item -Path usbmmidd_v2\Win32 -Recurse
          Remove-Item -Path "usbmmidd_v2\deviceinstaller64.exe", "usbmmidd_v2\deviceinstaller.exe", "usbmmidd_v2\usbmmidd.bat"
          mv -Force .\usbmmidd_v2 ./rustdesk

          # 5. ä¸‹è½½æ‰“å°æœºé©±åŠ¨ (ä¿æŒåŸé€»è¾‘)
          try {
            Invoke-WebRequest -Uri https://github.com/rustdesk/hbb_common/releases/download/driver/rustdesk_printer_driver_v4-1.4.zip -OutFile rustdesk_printer_driver_v4-1.4.zip
            Invoke-WebRequest -Uri https://github.com/rustdesk/hbb_common/releases/download/driver/printer_driver_adapter.zip -OutFile printer_driver_adapter.zip
            Expand-Archive rustdesk_printer_driver_v4-1.4.zip -DestinationPath .
            mkdir ./rustdesk/drivers
            mv -Force .\rustdesk_printer_driver_v4-1.4 ./rustdesk/drivers/RustDeskPrinterDriver
            Expand-Archive printer_driver_adapter.zip -DestinationPath .
            mv -Force .\printer_driver_adapter.dll ./rustdesk
          } catch {
              Write-Host "Ingore the printer driver error."
          }

      - name: find Runner.res
        continue-on-error: true
        shell: bash
        run: |
          runner_res=$(find . -name "Runner.res");
          if [ "$runner_res" == "" ]; then echo "Runner.res: not found"; else cp $runner_res ./libs/portable/Runner.res; fi

      - name: Download RustDeskTempTopMostWindow artifacts
        uses: actions/download-artifact@master
        with:
          name: topmostwindow-artifacts
          path: "./rustdesk"

      - name: Upload unsigned files
        uses: actions/upload-artifact@master
        with:
          name: BGDesk-Unpacked-Windows-${{ matrix.job.arch }}
          path: rustdesk

      # ğŸ”¥ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šæ‰“åŒ…ç»¿è‰²ç‰ˆ (ä½¿ç”¨ BGDesk.exe)
      - name: Build self-extracted executable
        shell: bash
        run: |
          sed -i '/dpiAware/d' res/manifest.xml
          pushd ./libs/portable
          pip3 install -r requirements.txt
          # ä½¿ç”¨ BGDesk.exe ä½œä¸ºè¾“å…¥
          python3 ./generate.py -f ../../rustdesk/ -o . -e ../../rustdesk/BGDesk.exe
          popd
          mkdir -p ./SignOutput
          # é‡å‘½åè¾“å‡º
          mv ./target/release/rustdesk-portable-packer.exe ./SignOutput/BGDesk-${{ env.VERSION }}-${{ matrix.job.arch }}.exe

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      # ğŸ”¥ MSI æ„å»º (å¯é€‰ä¿ç•™ï¼Œä¿ç•™å®ƒæ›´ç¨³å¦¥ï¼Œå¦‚æœä¸è¦å®‰è£…åŒ…å¯æ³¨é‡Šæ‰)
      - name: Build msi
        run: |
          pushd ./res/msi
          python preprocess.py --arp -d ../../rustdesk
          nuget restore msi.sln
          msbuild msi.sln -p:Configuration=Release -p:Platform=x64 /p:TargetVersion=Windows10
          # MSI ä»å« rustdesk-xxx.msi é¿å…è„šæœ¬æŠ¥é”™ï¼Œå¦‚æœä½ æƒ³æ”¹ MSI åå¯ä»¥åœ¨è¿™é‡Œ mvï¼Œä½†æ²¡å¿…è¦
          mv ./Package/bin/x64/Release/en-us/Package.msi ../../SignOutput/rustdesk-${{ env.VERSION }}-${{ matrix.job.arch }}.msi

      # ğŸ”¥ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šå‘å¸ƒäº§ç‰©ï¼Œç¡®ä¿åŒ…å« BGDesk
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          prerelease: true
          tag_name: ${{ env.TAG_NAME }}
          files: |
            ./SignOutput/rustdesk-*.msi
            ./SignOutput/BGDesk-*.exe